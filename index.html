<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>影響計算システム（実験公開版）</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="./css/style.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <header class="brand">
        <span class="title">影響計算システム（実験公開版）</span>
        <select class="mode-select">
          <option>交通量</option>
        </select>
      </header>

      <nav class="tabs">
        <button class="tab active" data-tab="home">ホーム</button>
        <button class="tab" data-tab="calc">計算</button>
        <button class="tab" data-tab="report">レポート</button>
      </nav>

      <section class="panel" data-panel="home">
        <p class="muted">ホーム</p>

        <label class="field">
          <span>住所を入力（Enterで検索 / 候補クリックで移動）</span>
          <input id="addr-input" placeholder="広島市中区紙屋町" />
        </label>
        <div id="addr-results" class="results"></div>
        <div class="row gap" style="margin-top:8px">
          <button id="addr-fly">移動</button>
          <button id="map-update" class="accent">地図更新</button>
        </div>
        <p class="hint">住所を入力 → Enter → 候補を選択（または「移動」で直近候補へ）。「地図更新」で最新状態を反映。</p>

        <hr/>

        <div class="section">
          <strong>通行止め：道路選択/解除</strong>
          <div class="row gap">
            <button id="closure-mode">選択</button>
            <button id="closure-clear">解除</button>
          </div>
          <p class="hint">「選択」で通行止めをONにし、道路をクリックすると黒塗り（通行止め）／右クリックで解除。／Enter,ESCでOFF<br/>「解除」で選択した通行止め区画をすべて解除。</p>
        </div>
        <div class="section" style="margin-top:8px">
          <strong>閉鎖設定</strong>
          <div class="row gap">
            <label class="radio"><input type="radio" name="closure-type" id="closure-full" value="full" checked> 完全閉鎖</label>
            <label class="radio"><input type="radio" name="closure-type" id="closure-partial" value="partial"> 部分閉鎖</label>
          </div>
          <div class="row gap" id="partial-box" style="margin-top:6px; display:none;">
            <label>閉鎖車線数: <input id="closed-lanes" type="number" min="1" value="1" style="width:64px"></label>
            <span class="muted">（選択路の全車線数から自動判定）</span>
          </div>
        </div>

        <div class="section" style="margin-top:8px">
          <strong>移動経路設定</strong>
          <div class="row gap">
            <button id="route-start">経路選択開始</button>
            <button id="route-reset">リセット</button>
          </div>
          <p class="hint">左クリックで端点/折れ点の指定、右クリックで１つ戻す、ESCで作業を中断、Enterで決定</p>
        </div>

        <div class="section" style="margin-top:8px">
          <strong>操作説明</strong>
          <div class="row gap">
            <button id="btn-open-manual">操作説明書</button>
          </div>
          <p class="hint">画面構成と基本操作を写真付きで説明した操作説明書を表示します。</p>
        </div>

        <div id="side-panel">
          <!-- ここに「ホーム」「計算」「レポート」など既存の内容が入る -->

          <!-- ↓ このブロックをパネルの一番下に追加する ↓ -->
          <div class="panel-refresh-note">
            Ctrl＋F5 で地図を更新　交通量は補正をかけたものを利用しています
          </div>
        </div>

      </section>

      <section class="panel hidden" data-panel="calc">
        <div class="row gap">
          <label>伝播区画:
            <input id="k-range" type="number" min="0" max="20" value="6" />
          </label>
          <label>時刻:
            <input id="time-range" type="range" min="0" max="23" step="1" value="0" />
            <span id="time-label">00</span>
          </label>
        </div>

        <div class="row gap" style="margin-top:8px">
          <strong>表示する交通量：</strong>
          <label class="radio"><input type="radio" name="view-mode" value="before" checked> 計算前</label>
          <label class="radio"><input type="radio" name="view-mode" value="after"> 計算後</label>
        </div>
        <div class="row gap">
          <strong>方向：</strong>
          <label class="radio"><input type="radio" name="dir" value="up" checked> 上り</label>
          <label class="radio"><input type="radio" name="dir" value="down"> 下り</label>
        </div>
        <div class="row gap">
          <button id="btn-run">計算実行</button>
        </div>
        <p class="hint">「計算実行」は移動経路を選択後にのみ実行できます</p>
      </section>

      <section class="panel hidden" data-panel="report">
        <div class="row gap">
          <button id="export-csv">CSV出力</button>
          <button id="btn-screenshot">スクリーンショット</button>
        </div>
        <p class="hint">CSV出力は、ダウンロードファイルに「impact-report-r500.csv」というファイル名で出力されます</p>

        <hr />

        <div class="row gap" style="margin-top:8px">
          <button id="btn-report-aggregate">データ集計（半径500m）</button>
          <button id="btn-report-range">範囲表示</button>
        </div>
        <p class="hint">通行止め区画、移動経路選択地点から半径500m以内に含まれる道路区画を集計し、上位20区画のデータを表示します。</p>

        <div class="row gap" style="margin-top:8px">
          <strong>集計基準：</strong>
          <label class="radio"><input type="radio" name="report-sort" value="traffic" checked> 交通量</label>
          <label class="radio"><input type="radio" name="report-sort" value="R"> 渋滞率</label>
        </div>

        <div class="table-wrap" style="margin-top:8px; max-height:220px; overflow:auto;">
          <table id="report-top-table">
            <thead>
              <tr>
                <th>区画番号</th>
                <th>距離(m)</th>
                <th>交通</th>
                <th>渋滞率R</th>
                <th>容量</th>
              </tr>
            </thead>
            <tbody>
              <tr class="placeholder">
                <td colspan="5">「データ集計」を押すと結果が表示されます</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </aside>

    <main class="map-wrap">
      <div id="map"></div>

      <div class="legend card">
        <div class="legend-title">凡例（R ＝ 交通量 / 容量）</div>
        <div class="legend-item"><span class="chip c1"></span> 余裕（＜20%）</div>
        <div class="legend-item"><span class="chip c2"></span> 注意（20–35%）</div>
        <div class="legend-item"><span class="chip c3"></span> 要注意（35–50%）</div>
        <div class="legend-item"><span class="chip c4"></span> 混雑（50–70%）</div>
        <div class="legend-item"><span class="chip c5"></span> 大混雑（70–90%）</div>
        <div class="legend-item"><span class="chip c6"></span> 逼迫（90%以上）</div>
        <div class="legend-src">地理院タイル / Project PLATEAU / 本試作システム</div>
      </div>
    </main>
  </div>

  <!-- 利用規約オーバーレイ -->
  <div id="intro-overlay" class="intro-overlay">
    <div class="intro-card">
      <h1 class="intro-title">利用規約</h1>
      <div class="intro-body" id="intro-html">
        <!-- intro.js が <pre class="intro-pre">...</pre> を差し込み -->
      </div>
      <div class="intro-agree">
        <label>
          <input type="checkbox" id="intro-agree-checkbox">
          利用規約に同意します
        </label>
      </div>
      <div class="intro-actions">
        <button id="intro-start-btn" disabled>開始</button>
      </div>
    </div>
  </div>

  <!-- 操作説明書オーバーレイ -->
  <div id="manual-overlay" class="intro-overlay hidden">
    <div class="intro-card manual-card">
      <h1 class="intro-title">操作説明書</h1>
      <div class="intro-body manual-body" id="manual-body"></div>
      <div class="intro-actions">
        <button id="manual-close-btn">閉じる</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- 利用前オーバーレイ制御 -->
  <script type="module" src="./js/intro/intro.js"></script>

  <!-- 操作説明書オーバーレイ制御 -->
  <script type="module" src="./js/intro/manual.js"></script>

  <!-- 既存のアプリ本体スクリプト -->
  <script type="module" src="./js/app.js"></script>
</body>
</html>
