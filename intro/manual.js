// 操作説明書オーバーレイ制御 & コンテンツ生成
document.addEventListener('DOMContentLoaded', () => {
  const btnManual   = document.getElementById('btn-open-manual');
  const overlay     = document.getElementById('manual-overlay');
  const closeBtn    = document.getElementById('manual-close-btn');
  const body        = document.getElementById('manual-body');

  if (!btnManual || !overlay || !closeBtn || !body) return;

  // マニュアル本文（テキスト）
  const manualText = `【影響計算システム 操作説明書（ホーム／計算／集計パネル）】

==================================================
1. ホームパネル
==================================================

■ 1-1. 住所入力による地図移動

概要：
ホームパネル上部の「住所を入力（Enterで検索／候補クリックで移動）」欄に市区町村名・施設名・住所を入力すると、その位置に地図を移動できます。

操作手順：
1) 住所入力欄にキーワード（例：広島市）を入力する。
2) Enterキーを押すか、候補リストからクリックして選択する。
3) 「移動」ボタンを押すと、その地点へズーム移動する。
4) 必要に応じて「地図更新」を押し、最新状態を反映させる。

補足：
・候補選択後に「移動」を押すと、最寄り候補へジャンプします。
・「地図更新」は、検索後などにUIと地図表示を同期させたい場合に使用します。


■ 1-2. 通行止め設定（道路選択／解除）

概要：
道路区画をクリックすることで、その区間を通行止め（黒塗り）に設定できます。工事計画で「どの道路を閉鎖するか」を仮想的に設定できます。

操作手順：
1) ホームパネルの「通行止め：道路選択/解除」で「選択」ボタンを押し、通行止めモードをONにする。
2) 地図上で閉鎖したい道路区画を左クリックする。
   → 該当区画が黒く塗られ、通行止め状態になる。
3) 通行止めを個別に解除したい場合は、黒塗り区画を右クリックする。
4) Enter または ESC キーで通行止めモードをOFFにする。
5) 「解除」ボタンを押すと、設定した通行止め区画をまとめて解除できる。

補足：
・クリックは道路中心線付近で行うと選択しやすくなります。
・通行止め設定は、後述の「計算パネル」での交通量計算に反映されます。


■ 1-3. 閉鎖設定（完全閉鎖／部分閉鎖）

概要：
閉鎖の強さを「完全閉鎖」「部分閉鎖」から選択します。

内容：
・完全閉鎖：対象道路区画を全て閉鎖として扱います。
・部分閉鎖：車線規制などを想定した、容量低下を前提とした計算用モードです（将来拡張を含む）。


■ 1-4. 移動経路選択（迂回ルート指定）

概要：
規制時に想定される迂回ルートを、地図上で端点→折れ点→終点の順にクリックして指定します。

操作手順：
1) 「移動経路設定」内の「経路選択開始」ボタンを押す。
2) 地図上で左クリックし、端点・折れ点を順番に指定する。
3) 誤って指定した場合は、右クリックで1手戻る。
4) Enterキーで経路を確定する。（この時最後に設定した区画が終点となります）
5) ESCキーで経路選択をキャンセルする。
6) 「リセット」ボタンで、設定済みの経路を全て削除する。

補足：
・設定した経路は青色ラインとして表示されます。
・経路は「計算実行」時の交通量再配分に利用されます。


==================================================
2. 計算パネル（交通量計算）
==================================================

■ 2-1. パネル概要

計算パネルでは、伝播区画・時刻・方向・表示種別（計算前／計算後）を指定し、「計算実行」ボタンで交通量を再計算します。通行止め設定・移動経路設定を反映した交通影響を確認できます。

■ 2-2. 各項目の説明

1) 伝播区画：
   ・計算の起点となる区画番号を指定します。
   ・この区画から幹線／生活道路に向かって交通量を伝播させます。

2) 時刻（スライダー）：
   ・スライダーで任意の時間帯（例：19時）を指定します。
   ・時間帯により交通量が変化する場合の比較に使用します。

3) 表示する交通量：
   ・計算前：規制前の基準交通量を表示。
   ・計算後：通行止め・迂回経路を反映した結果交通量を表示。

4) 方向：
   ・上り／下りを切り替えて表示します。
   ・方向付きリンクの交通量確認に使用します。

■ 2-3. 計算実行

操作手順：
1) あらかじめ「移動経路選択」で迂回ルートを設定する。
2) 必要に応じて伝播区画・時刻・方向を設定する。
3) 「計算実行」ボタンを押す。
4) 計算完了後、地図上の道路が容量比 R（交通量/容量）に応じて色分けされる。

注意：
・移動経路が未設定の場合、「計算実行」は行えません（システム上は無効扱いとなります）。


==================================================
3. CSV出力・スクリーンショット
==================================================

■ 3-1. CSV出力

概要：
集計パネルに表示している結果を、CSVファイルとしてダウンロードします。

仕様：
・ファイル名：impact-report-r500.csv
・ダウンロード先：ブラウザの設定による（通常は「ダウンロード」フォルダ）

用途：
・社内資料・報告書への貼り付け
・Excel等での追加集計・グラフ化

■ 3-2. スクリーンショット

概要：
現在の地図表示領域を画像として保存します。

用途：
・説明資料への図版として利用
・比較用に複数パターンを保存しておく場合など


==================================================
4. データ集計パネル（半径500m）
==================================================

■ 4-1. パネル概要

通行止め区画または移動経路の起点から半径500m以内に含まれる道路区画を自動集計し、影響が大きい上位20区画を一覧表示します。

■ 4-2. 主なボタン

1) データ集計（半径500m）：
   ・通行止め区画または移動経路起点を中心に、半径500mの範囲に含まれる区画を集計します。

2) 範囲表示：
   ・地図上に半径500mの円を表示し、集計対象範囲を可視化します。

■ 4-3. 集計基準

・交通量：区画の交通量を基準に降順ソート。
・渋滞率：R値（交通量/容量）を基準に降順ソート。

■ 4-4. 集計表の項目

・区画番号：道路区画のID。
・距離（m）：中心点から区画中心までのおおよその距離。
・交通量：対象時刻・方向における交通量。
・渋滞率R：R = 交通量 / 容量。
・容量：想定容量。ここを書き換えることでR値の再評価が可能。


==================================================
5. 交通量表示の凡例
==================================================

地図上の道路色は、容量比 R（交通量 / 容量）に応じて次のように色分けされています。

・緑　　　：余裕（R < 20%）
・黄緑　　：注意（20% ≦ R < 35%）
・黄　　　：要注意（35% ≦ R < 50%）
・オレンジ：混雑（50% ≦ R < 70%）
・赤　　　：大混雑（70% ≦ R < 90%）
・濃赤　　：逼迫（90% 以上）

この色分けにより、「どの区間がどの程度混雑しているか」を一目で把握できます。


==================================================
6. 一連の操作フロー（例）
==================================================

1) ホームパネルで場所を検索し、地図を対象地点へ移動する。
2) 通行止めモードで、閉鎖したい道路区画を黒塗りに設定する。
3) 移動経路選択で想定する迂回ルートを指定し、Enterで確定する。
4) 計算パネルで伝播区画・時刻・方向を設定し、「計算実行」を押す。
5) 色分けされた地図と凡例を参照し、影響範囲や混雑区間を確認する。
6) 必要に応じて、データ集計（半径500m）とCSV出力で、周辺区画の詳細データを取得する。
7) スクリーンショット機能で画面を保存し、説明資料などに貼り付ける。

以上が、本システムのホームパネル・計算パネル・集計パネルに関する基本的な操作手順です。
`;

  // 画像付きHTMLを組み立て
  const html = `
    <section class="manual-section">
      <h2>1. ホームパネル</h2>
      <figure>
        <img src="./photo/juusyoidou.png" alt="住所入力による地図移動" />
        <figcaption>住所入力による地図移動</figcaption>
      </figure>
      <figure>
        <img src="./photo/tuukoudomebotann.png" alt="通行止めボタン" />
        <figcaption>通行止め：道路選択/解除ボタン</figcaption>
      </figure>
      <figure>
        <img src="./photo/tuukoudomehyouji.png" alt="通行止め表示" />
        <figcaption>通行止め区間の表示例</figcaption>
      </figure>
      <figure>
        <img src="./photo/idoukeirobotann.png" alt="移動経路ボタン" />
        <figcaption>移動経路設定ボタン</figcaption>
      </figure>
      <figure>
        <img src="./photo/idoukeirohyouji.png" alt="移動経路表示" />
        <figcaption>移動経路（迂回ルート）の表示例</figcaption>
      </figure>
    </section>

    <section class="manual-section">
      <h2>2. 計算パネル・色分け表示</h2>
      <figure>
        <img src="./photo/keisannbotann.png" alt="計算パネル" />
        <figcaption>計算パネルと計算実行ボタン</figcaption>
      </figure>
      <figure>
        <img src="./photo/irotukebotann.png" alt="交通量の色分け表示" />
        <figcaption>計算結果（交通量の色分け表示）</figcaption>
      </figure>
    </section>

    <section class="manual-section">
      <h2>3. レポート・データ集計</h2>
      <figure>
        <img src="./photo/repo-tobotann.png" alt="CSV出力・スクリーンショット" />
        <figcaption>CSV出力・スクリーンショットボタン</figcaption>
      </figure>
      <figure>
        <img src="./photo/syuukeibotann.png" alt="データ集計ボタン" />
        <figcaption>データ集計（半径500m）ボタン</figcaption>
      </figure>
      <figure>
        <img src="./photo/syuukeihannihyouji.png" alt="集計範囲の表示" />
        <figcaption>集計範囲（半径500m）の表示例</figcaption>
      </figure>
      <figure>
        <img src="./photo/syuukeikekka.png" alt="集計結果テーブル" />
        <figcaption>集計結果テーブルの表示例</figcaption>
      </figure>
    </section>

    <section class="manual-section">
      <h2>4. 凡例（R = 交通量 / 容量）</h2>
      <figure>
        <img src="./photo/hannrei.png" alt="凡例" />
        <figcaption>凡例パネル（道路色の意味）</figcaption>
      </figure>
    </section>

    <section class="manual-section">
      
      <pre class="manual-pre">${manualText}</pre>
    </section>
  `;

  body.innerHTML = html;

  // 開く
  btnManual.addEventListener('click', () => {
    overlay.classList.remove('hidden');
  });

  // 閉じる
  const close = () => {
    overlay.classList.add('hidden');
  };
  closeBtn.addEventListener('click', close);
  overlay.addEventListener('click', (ev) => {
    if (ev.target === overlay) close();
  });
  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape') close();
  });
});
